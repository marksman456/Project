@model Project.ViewModels.Quotation.QuotationViewModel


@await Html.PartialAsync("_StatusMessage")
@{
    ViewData["Title"] = "報價單詳細資料";
}

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h2 class="mb-0">@ViewData["Title"]</h2>
            <h4 class="mb-0 text-muted">@Model.QuotationNumber</h4>
        </div>

        @* --- 主檔資訊 --- *@
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-2"> @Html.DisplayNameFor(model => model.MemberName)</dt>
                <dd class="col-sm-4">@Model.MemberName</dd>

                <dt class="col-sm-2">   @Html.DisplayNameFor(model => model.EmployeeName)</dt>
                <dd class="col-sm-4">@Model.EmployeeName</dd>

                <dt class="col-sm-2"> @Html.DisplayNameFor(model => model.QuoteDate)</dt>
                <dd class="col-sm-4">@Model.QuoteDate.ToString("yyyy-MM-dd")</dd>

                <dt class="col-sm-2"> @Html.DisplayNameFor(model => model.ValidityPeriod)</dt>
                <dd class="col-sm-4">
                    @(Model.ValidityPeriod.HasValue
                                        ? Model.ValidityPeriod.Value.ToString("yyyy-MM-dd")
                                        : "--")
                </dd>


                <dt class="col-sm-2"> @Html.DisplayNameFor(model => model.Status)</dt>
                <dd class="col-sm-4">@Model.Status</dd>


                <dt class="col-sm-2"> @Html.DisplayNameFor(model => model.Note)</dt>
                <dd class="col-sm-4">@Model.Note</dd>

            </dl>

        </div>

        <hr class="my-0" />

        @* --- 明細資訊 --- *@
        <div class="card-body">
            <h5 class="card-title">報價品項</h5>
            @* --- 請將整個 table 區塊替換為以下版本 --- *@
            <h4>報價明細</h4>
            <table class="table table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>商品名稱 (規格)</th>
                        <th class="text-end">單價</th>
                        <th class="text-center">數量</th>
                        <th class="text-center">折扣</th>
                        <th class="text-end">小計</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        decimal totalAmount = 0;
                    }
                    @foreach (var item in Model.QuotationDetail)
                    {
                        var subtotal = item.Price * item.Quantity * (item.Discount ?? 1.0m);
                        totalAmount += subtotal;
                        <tr>
                            <td>
                                @Html.DisplayFor(modelItem => item.ProductNameAndSpec)
                                (@Html.DisplayFor(modelItem => item.ProductStatus))
                            </td>
                            <td class="text-end">@item.Price.ToString("N2")</td>
                            <td class="text-center">@item.Quantity</td>
                            <td class="text-center">
                                @(item.Discount.HasValue && item.Discount.Value < 1m
                                                            ? (item.Discount.Value * 10 % 1 == 0
                                                            ? $"{(int)(item.Discount.Value * 10)}折"
                                                            : $"{item.Discount.Value * 10:0.#}折")
                                                            : "--")
                        </td>
                            <td class="text-end">@subtotal.ToString("N2")</td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" class="text-end fw-bold">總計</td>
                        <td class="text-end fw-bold">@totalAmount.ToString("N2")</td>
                    </tr>
                </tfoot>
            </table>
        </div>






        <div class="card-footer text-center">
            <div class="d-flex justify-content-center gap-2">
                <a asp-action="Edit" asp-route-id="@Model.QuotationID" class="btn btn-primary">編輯訂單</a>
                

@* --- 請將原本的「建立訂單」按鈕區塊，完整替換為以下程式碼 --- *@
        <div>
            @* 只有當報價單狀態為「報價中」，才顯示此按鈕 *@
            @if (Model.Status == "報價中")
            {
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createOrderModal">
                    <i class="bi bi-cart-check-fill"></i> 建立訂單
                </button>
            }
        </div>

        <div class="modal fade" id="createOrderModal" tabindex="-1" aria-labelledby="createOrderModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form asp-area="Admin" asp-controller="Orders" asp-action="CreateFromQuotation" method="post">
                        <div class="modal-header">
                            <h5 class="modal-title" id="createOrderModalLabel">建立訂單 - @Model.QuotationNumber</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>請確認此訂單的最終資訊：</p>

                            @* 將 QuotationID 透過隱藏欄位傳遞 *@
                            <input type="hidden" name="quotationId" value="@Model.QuotationID" />

                            <div class="mb-3">
                                <label for="paymethodId" class="form-label">付款方式</label>
                                <select name="paymethodId" class="form-select" asp-items="Model.PaymethodList" required>
                                    <option value="">-- 請選擇 --</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="salesChannelId" class="form-label">銷售管道</label>
                                        <select name="salesChannelId" class="form-select" asp-items="Model.SalesChannelList" required>
                                    <option value="">-- 請選擇 --</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary" onclick="return confirm('您確定要將此報價單轉換為正式訂單嗎？');">確認建立</button>
                        </div>
                    </form>

                           
                </div>
            </div>
        </div>
                <a asp-action="Index" class="btn btn-secondary">返回列表</a>
            </div>
           
        </div>
    </div>
</div>