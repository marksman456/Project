@model ProjectData.Models.Order

@{
    ViewData["Title"] = "訂單詳細資料";
}

<h1>@ViewData["Title"]</h1>
<hr />

<div class="row">
    <div class="col-md-6">
        <dl class="row">
            <dt class="col-sm-4">訂單編號</dt>
            <dd class="col-sm-8">@Model.OrderNumber</dd>

            <dt class="col-sm-4">訂單日期</dt>
            <dd class="col-sm-8">@Model.OrderDate.ToString("yyyy-MM-dd HH:mm")</dd>

            <dt class="col-sm-4">客戶名稱</dt>
            <dd class="col-sm-8">@Model.Member.Name</dd>

            <dt class="col-sm-4">經手員工</dt>
            <dd class="col-sm-8">@Model.Employee.Name</dd>
        </dl>
    </div>
    <div class="col-md-6">
        <dl class="row">
            <dt class="col-sm-4">訂單狀態</dt>
            <dd class="col-sm-8">@Model.Status</dd>

            <dt class="col-sm-4">付款狀態</dt>
            <dd class="col-sm-8">
                @if (Model.IsPaid)
                {
                    <span class="badge bg-success">已付款</span>
                }
                else
                {
                    <span class="badge bg-warning text-dark">未付款</span>
                }
            </dd>

            <dt class="col-sm-4">付款方式</dt>
            <dd class="col-sm-8">@Model.Paymethod?.PaymethodName</dd>

            <dt class="col-sm-4">銷售管道</dt>
            <dd class="col-sm-8">@Model.SalesChannel?.SalesChannelName</dd>
        </dl>
    </div>
</div>
<div class="row mt-2">
    <div class="col-12">
        <dl class="row">
            <dt class="col-sm-2">備註</dt>
            <dd class="col-sm-10">@Model.Note</dd>
        </dl>
    </div>
</div>


<h4 class="mt-4">訂單明細</h4>
<table class="table table-bordered">
    <thead class="table-light">
        <tr>
            <th>商品名稱</th>
            <th>序號</th>
            <th class="text-end">單價</th>
            <th class="text-center">數量</th>
            <th class="text-center">折扣</th>
            <th class="text-end">小計</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model.OrderDetail)
        {
            // 因為所有型別都已是 decimal，不再需要 (decimal) 強制轉型
            var subtotal = item.Price * item.Quantity * (item.Discount ?? 1.0m);
            <tr>
                <td>@item.ProductDetail.Product.ProductName</td>
                <td>@item.ProductDetail.SerialNumber</td>
                <td class="text-end">@item.Price.ToString("N0")</td>
                <td class="text-center">@item.Quantity</td>
                <td class="text-center">
                    @(item.Discount == null || item.Discount.Value == 1.0m ? "--" : $"{(item.Discount.Value * 10).ToString("0.#")}折")
                </td>
                <td class="text-end">@subtotal.ToString("N0")</td>
            </tr>
        }
    </tbody>
    <tfoot>
        <tr>
            <td colspan="5" class="text-end fw-bold">總計</td>
            <td class="text-end fw-bold">@Model.TotalAmount.ToString("N0")</td>
        </tr>
    </tfoot>
</table>

@if (!Model.IsPaid && User.IsInRole("Admin"))
{
    <form asp-action="MarkAsPaid" asp-route-id="@Model.OrderID" method="post" class="d-inline">
        <button type="submit" class="btn btn-success" onclick="return confirm('您確定要將此訂單標記為「已付款」嗎？此操作無法復原。')">
            <i class="bi bi-check-circle-fill"></i> 標記為已付款
        </button>
    </form>
}

@if (Model.Status == "待出貨" || Model.Status == "訂單成立" && User.IsInRole("Admin"))
{
    <form asp-action="MarkAsShipped" asp-route-id="@Model.OrderID" method="post" class="d-inline">
        <button type="submit" class="btn btn-info" onclick="return confirm('您確定要將此訂單標記為「已出貨」嗎？')">
            <i class="bi bi-truck"></i> 標記為已出貨
        </button>
    </form>
}

<div class="mt-3">
    <a asp-action="Index" class="btn btn-secondary">返回列表</a>
</div>